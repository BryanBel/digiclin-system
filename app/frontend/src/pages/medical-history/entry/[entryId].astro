---
import Layout from '../../../layouts/Layout.astro';
import MedicalHistoryEntryDetailContent from '../../../components/MedicalHistoryEntryDetailContent.jsx';

const { entryId } = Astro.params;

let patientName = 'Cargando...';
let entryTitle = 'Detalles de Entrada';

if (entryId) {
  try {
    // This fetch will run on the server during build or SSR
    const response = await fetch(`http://localhost:3000/api/medical-history/${entryId}`);
    if (response.ok) {
      const entryData = await response.json();
      if (entryData && entryData.patient_id) {
        const patientResponse = await fetch(`http://localhost:3000/api/patients/${entryData.patient_id}`);
        if (patientResponse.ok) {
          const patientData = await patientResponse.json();
          patientName = patientData.name || 'Paciente Desconocido';
          entryTitle = `Entrada de Historial de ${patientName}`;
        }
      }
    }
  } catch (error) {
    console.error('Error fetching data for title during SSR:', error);
  }
}
---
<Layout title={entryTitle}>
  <main class="min-h-[calc(100vh-4rem)] bg-gradient-to-br from-purple-100 via-purple-300 to-purple-500 p-4">
    <MedicalHistoryEntryDetailContent entryId={entryId} client:load />
  </main>
</Layout>