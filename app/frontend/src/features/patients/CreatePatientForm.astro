
---
// A form to create a new patient.
---
<form id="create-patient-form" class="flex flex-col gap-4 p-4 border border-gray-300 rounded-md mb-8">
  <h3 class="text-lg font-bold">Añade un nuevo paciente</h3>
  <div>
    <label for="patient-name" class="block mb-2 text-sm font-medium text-gray-900">Nombre del paciente</label>
    <input type="text" id="patient-name" name="name" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="John Doe" required />
  </div>
  <div>
    <label for="patient-cedula" class="block mb-2 text-sm font-medium text-gray-900">Cédula (Opcional)</label>
    <input type="text" id="patient-cedula" name="cedula" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="V-12345678" />
  </div>
  <div>
    <label for="patient-phone" class="block mb-2 text-sm font-medium text-gray-900">Teléfono (Opcional)</label>
    <input type="tel" id="patient-phone" name="phone" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="0412-1234567" />
  </div>
  <div id="form-error" class="text-red-500 text-sm hidden" role="alert"></div>
  <button type="submit" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm w-full sm:w-auto px-5 py-2.5 text-center disabled:bg-blue-400 disabled:cursor-not-allowed">Añadir paciente</button>
</form>

<script>
  import PatientsModule from './PatientsModule.js';

  const form = document.getElementById('create-patient-form') as HTMLFormElement | null;
  const submitButton = form?.querySelector('button[type="submit"]') as HTMLButtonElement | null;
  const errorDiv = document.getElementById('form-error') as HTMLDivElement | null;

  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!submitButton || !errorDiv) return;

      // Disable button and clear previous errors
      submitButton.disabled = true;
      submitButton.textContent = 'Añadiendo...';
      errorDiv.classList.add('hidden');
      errorDiv.textContent = '';

      const formData = new FormData(form);
      const name = formData.get('name');
      const cedula = formData.get('cedula');
      const phone = formData.get('phone');
      
      if (typeof name === 'string' && name.trim() !== '') {
        try {
          const patientData = {
            name,
            cedula: typeof cedula === 'string' && cedula.trim() !== '' ? cedula : null,
            phone: typeof phone === 'string' && phone.trim() !== '' ? phone : null,
          };

          await PatientsModule.addPatient(patientData);
          form.reset();
        } catch (error: any) {
          console.error("Failed to add patient:", error);
          errorDiv.textContent = error.message || 'No se pudo añadir el paciente. Intente de nuevo.';
          errorDiv.classList.remove('hidden');
        } finally {
          // Re-enable button
          submitButton.disabled = false;
          submitButton.textContent = 'Añadir paciente';
        }
      }
    });
  }
</script>
